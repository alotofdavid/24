<html>
<head>
<title>24</title>
<script type="text/javascript">
var inGame = false;
var inspection = false;
var size;
var gameState;
var emptyTile;
var updateTimerInterval;
var startTime;
var curTime;
var bestTime = 1000000
var times = [];
function init() {
  console.log('initializing');
  size = 5;
  loadBoard();
  drawBoard();
}

function testShuffle() {
  shiftRight();
  drawBoard();
}

function startGame() {
  document.getElementById("board").innerHTML = "";
  loadBoard();
  shuffle();
  inspection = true;
  inGame = true; 
}

function loadBoard() {
  gameState = [];
  var count = 1;
  var div;
  for (var i=0; i<size; i++) {
    for (var j=0; j<size; j++) {
      div = document.createElement("div");
      div.innerHTML = count;
      div.classList.add("tile");
      div.id = count;
      gameState.push(div);
      count++;
      if (count===size*size) {
        div = document.createElement("div");
        div.classList.add("tile");
        div.classList.add("blank");
        gameState.push(div);
        emptyTile = count-1; //count is 1 indexed, but the gameState array is 0 indexed
        break;
      }
    } 
  }
}

function drawBoard() {
  game = document.getElementById("board");
  for (var i=0; i<gameState.length; i++) {
    game.appendChild(gameState[i]);
    if ((i+1)%5===0) { 
      var clear = document.createElement("div")
      clear.classList.add("clear")
      game.appendChild(clear);
    }
  }
  if (inGame) check();
}

function range(start, end) {
  var arr = [];
  for (var i=start; i<=end; i++) {
    arr.push(i);
  }
  return arr;
}

function keypress(code) { 
  if (inspection && (code===37 || code===38 || code===39 || code ===40)) {
    startTimer();
    inspection = false;
  }
  if (code===37) shiftLeft();
  if (code===38) shiftUp();
  if (code===39) shiftRight();
  if (code===40) shiftDown();

  if (code===32 && !inGame) startGame();
}

function shiftLeft(suppress) { 
  if (emptyTile%size!=size-1) {
    swap(gameState,emptyTile,emptyTile+1);
    emptyTile = emptyTile+1;
    if (!suppress) drawBoard();
  }
}

function shiftUp(suppress) { 
  if (Math.floor(emptyTile/size)!=size-1) {
    swap(gameState,emptyTile,emptyTile+size);
    emptyTile = emptyTile+size;
    if (!suppress) drawBoard();
  }
}

function shiftRight(suppress) { 
  if (emptyTile%5!=0) {
    swap(gameState,emptyTile,emptyTile-1);
    emptyTile = emptyTile-1;
    if (!suppress) drawBoard();
  }
}

function shiftDown(suppress) { 
  if (Math.floor(emptyTile/size)!=0) {
    swap(gameState,emptyTile,emptyTile-size);
    emptyTile = emptyTile-size;
    if (!suppress) drawBoard();
  }
}

function shuffle() { 
  var rand;
  for (var i=0; i<1000; i++) {
    rand = Math.floor(Math.random()*4);
    switch (rand) {
      case 0:
        shiftLeft(true);
        continue;
      case 1:
        shiftRight(true);
        continue;
      case 2:
        shiftUp(true);
        continue;
      case 3:
        shiftDown(true);
        continue;
    }
  }
  drawBoard();
}

function swap(arr, i, j) {
  var temp = arr[i];
  arr[i] = arr[j];
  arr[j] = temp;
}

function check() {
  for (var i=0; i<gameState.length; i++) { 
    if (gameState[i].id!=i+1) return;
    if (i+1===size*size-1) stopTimer();
  }
}

function startTimer() {
  startTime = new Date();
  updateTimerInterval = setInterval(updateTimer, 10);
}

function updateTimer() {
  curTime = new Date();
  document.getElementById('timer').innerHTML = (curTime.getTime() - startTime.getTime())/1000;
}

function stopTimer() {
  clearInterval(updateTimerInterval);
  curTime = new Date();
  console.log(curTime, startTime);
  var time = (curTime.getTime() - startTime.getTime())/1000;
  times.push(time);
  inGame = false;
  update();
}

function update() {
  updateTimeHistory();
  updateStats();
}

function updateTimeHistory() {
  string = times.join(", ");
  document.getElementById("times").innerHTML = string;
}
function updateStats() {
  if (times[times.length-1] < bestTime) {
    bestTime = times[times.length-1];
  }
  writeStats();
}


function writeStats() {

  var string = "";
  //best time
  string += "Best time: "
  string += bestTime
  //best average of 5


  //best average of 12
  document.getElementById("stats").innerHTML = string;
}

</script>

<style type="text/css">
.tile.blank {
  background-color: #FFF;
}
.clear {
  clear:left;
}
.tile {
  background-color: #339933;
  color: #FFF;
  height:50px;
  line-height: 50px;
  width:50px;
  text-align: center;
  float:left;
  border:1px solid #000;
}
#timer { 
  padding:5px;
  font-size:1.5em;
}
</style>
</head>

<body onload="init()" onkeydown="keypress(event.keyCode)">
<div id="board"></div>
<div id="timer"></div>
<h2>Times</h2>
<div id="times"></div>
<h2>Stats</h2>
<div id="stats"></div>
</body>
</html>